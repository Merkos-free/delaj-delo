<purpose>
Выполнение исследования (discovery) на соответствующем уровне глубины.
Создаёт DISCOVERY.md (для уровней 2-3), который информирует создание PLAN.md.

Вызывается из шага mandatory_discovery в plan-phase.md с параметром глубины.

ПРИМЕЧАНИЕ: Для комплексного исследования экосистемы ("как эксперты строят это") используйте /gsd:research-phase, который создаёт RESEARCH.md.
</purpose>

<depth_levels>
**Этот воркфлоу поддерживает три уровня глубины:**

| Уровень | Название         | Время      | Результат                                      | Когда                                       |
| ------- | ---------------- | ---------- | ---------------------------------------------- | ------------------------------------------- |
| 1       | Быстрая проверка | 2-5 мин    | Без файла, продолжение с проверенными знаниями | Одна библиотека, подтверждение синтаксиса   |
| 2       | Стандартный      | 15-30 мин  | DISCOVERY.md                                   | Выбор между вариантами, новая интеграция    |
| 3       | Глубокое погружение | 1+ час   | Детальный DISCOVERY.md с точками валидации     | Архитектурные решения, новые проблемы       |

**Глубина определяется в plan-phase.md перед маршрутизацией сюда.**
</depth_levels>

<source_hierarchy>
**ОБЯЗАТЕЛЬНО: Context7 ПЕРЕД WebSearch**

Обучающие данные Claude устаревают на 6-18 месяцев. Всегда проверяйте.

1. **Context7 MCP СНАЧАЛА** — Актуальные документы, без галлюцинаций
2. **Официальная документация** — Когда Context7 не покрывает
3. **WebSearch ПОСЛЕДНИМ** — Только для сравнений и трендов

См. ~/.claude/get-shit-done/templates/discovery.md `<discovery_protocol>` для полного протокола.
</source_hierarchy>

<process>

<step name="determine_depth">
Проверьте параметр глубины, переданный из plan-phase.md:
- `depth=verify` → Уровень 1 (Быстрая проверка)
- `depth=standard` → Уровень 2 (Стандартное исследование)
- `depth=deep` → Уровень 3 (Глубокое погружение)

Маршрутизация к соответствующему рабочему процессу уровня ниже.
</step>

<step name="level_1_quick_verify">
**Уровень 1: Быстрая проверка (2-5 минут)**

Для: Одна известная библиотека, подтверждение что синтаксис/версия всё ещё корректны.

**Процесс:**

1. Найдите библиотеку в Context7:

   ```
   mcp__context7__resolve-library-id with libraryName: "[библиотека]"
   ```

2. Получите релевантную документацию:

   ```
   mcp__context7__get-library-docs with:
   - context7CompatibleLibraryID: [из шага 1]
   - topic: [конкретный вопрос]
   ```

3. Проверьте:

   - Текущая версия соответствует ожиданиям
   - Синтаксис API не изменился
   - Нет ломающих изменений в последних версиях

4. **Если подтверждено:** Вернитесь к plan-phase.md с подтверждением. DISCOVERY.md не нужен.

5. **Если обнаружены проблемы:** Эскалация до Уровня 2.

**Результат:** Устное подтверждение продолжения или эскалация до Уровня 2.
</step>

<step name="level_2_standard">
**Уровень 2: Стандартное исследование (15-30 минут)**

Для: Выбор между вариантами, новая внешняя интеграция.

**Процесс:**

1. **Определите что исследовать:**

   - Какие варианты существуют?
   - Каковы ключевые критерии сравнения?
   - Каков наш конкретный сценарий использования?

2. **Context7 для каждого варианта:**

   ```
   Для каждой библиотеки/фреймворка:
   - mcp__context7__resolve-library-id
   - mcp__context7__get-library-docs (mode: "code" для API, "info" для концепций)
   ```

3. **Официальная документация** для того, что Context7 не покрывает.

4. **WebSearch** для сравнений:

   - "[вариант A] vs [вариант B] {текущий_год}"
   - "[вариант] known issues"
   - "[вариант] with [наш стек]"

5. **Перекрёстная проверка:** Любая находка WebSearch → подтвердить через Context7/официальные доки.

6. **Создайте DISCOVERY.md** используя структуру ~/.claude/get-shit-done/templates/discovery.md:

   - Сводка с рекомендацией
   - Ключевые находки по каждому варианту
   - Примеры кода из Context7
   - Уровень уверенности (должен быть СРЕДНИЙ-ВЫСОКИЙ для Уровня 2)

7. Вернитесь к plan-phase.md.

**Результат:** `.planning/phases/XX-name/DISCOVERY.md`
</step>

<step name="level_3_deep_dive">
**Уровень 3: Глубокое погружение (1+ час)**

Для: Архитектурные решения, новые проблемы, высокорисковые выборы.

**Процесс:**

1. **Определите область исследования** используя ~/.claude/get-shit-done/templates/discovery.md:

   - Определите чёткую область
   - Определите границы включения/исключения
   - Перечислите конкретные вопросы для ответа

2. **Исчерпывающее исследование Context7:**

   - Все релевантные библиотеки
   - Связанные паттерны и концепции
   - Несколько тем на библиотеку при необходимости

3. **Глубокое чтение официальной документации:**

   - Руководства по архитектуре
   - Секции лучших практик
   - Руководства по миграции/обновлению
   - Известные ограничения

4. **WebSearch для контекста экосистемы:**

   - Как другие решали похожие проблемы
   - Опыт в продакшене
   - Подводные камни и антипаттерны
   - Недавние изменения/объявления

5. **Перекрёстная проверка ВСЕХ находок:**

   - Каждое утверждение WebSearch → проверить с авторитетным источником
   - Отметить что проверено vs предполагается
   - Отметить противоречия

6. **Создайте комплексный DISCOVERY.md:**

   - Полная структура из ~/.claude/get-shit-done/templates/discovery.md
   - Отчёт о качестве с атрибуцией источников
   - Уверенность по каждой находке
   - Если НИЗКАЯ уверенность в критической находке → добавить контрольные точки валидации

7. **Точка уверенности:** Если общая уверенность НИЗКАЯ, представить варианты перед продолжением.

8. Вернитесь к plan-phase.md.

**Результат:** `.planning/phases/XX-name/DISCOVERY.md` (комплексный)
</step>

<step name="identify_unknowns">
**Для Уровней 2-3:** Определите что нужно узнать.

Спросите: Что нам нужно узнать прежде чем планировать эту фазу?

- Выбор технологий?
- Лучшие практики?
- Паттерны API?
- Архитектурный подход?
  </step>

<step name="create_discovery_scope">
Используйте ~/.claude/get-shit-done/templates/discovery.md.

Включите:

- Чёткую цель исследования
- Области включения/исключения
- Предпочтения источников (официальные доки, Context7, текущий год)
- Структуру вывода для DISCOVERY.md
  </step>

<step name="execute_discovery">
Запустите исследование:
- Используйте веб-поиск для актуальной информации
- Используйте Context7 MCP для документации библиотек
- Предпочитайте источники текущего года
- Структурируйте находки по шаблону
</step>

<step name="create_discovery_output">
Запишите `.planning/phases/XX-name/DISCOVERY.md`:
- Сводка с рекомендацией
- Ключевые находки с источниками
- Примеры кода если применимо
- Метаданные (уверенность, зависимости, открытые вопросы, допущения)
</step>

<step name="confidence_gate">
После создания DISCOVERY.md проверьте уровень уверенности.

Если уверенность НИЗКАЯ:
Используйте AskUserQuestion:

- header: "Низкая уверенность"
- question: "Уверенность исследования НИЗКАЯ: [причина]. Как хотите продолжить?"
- options:
  - "Копать глубже" — Провести дополнительное исследование перед планированием
  - "Продолжить так" — Принять неопределённость, планировать с оговорками
  - "Пауза" — Мне нужно подумать

Если уверенность СРЕДНЯЯ:
Встроенно: "Исследование завершено (средняя уверенность). [краткая причина]. Продолжить с планированием?"

Если уверенность ВЫСОКАЯ:
Продолжайте напрямую, просто отметьте: "Исследование завершено (высокая уверенность)."
</step>

<step name="open_questions_gate">
Если DISCOVERY.md содержит open_questions:

Представьте их встроенно:
"Открытые вопросы из исследования:

- [Вопрос 1]
- [Вопрос 2]

Они могут повлиять на реализацию. Подтвердить и продолжить? (да / решить сначала)"

Если "решить сначала": Собрать ввод пользователя по вопросам, обновить исследование.
</step>

<step name="offer_next">
```
Исследование завершено: .planning/phases/XX-name/DISCOVERY.md
Рекомендация: [одна строка]
Уверенность: [уровень]

Что дальше?

1. Обсудить контекст фазы (/gsd:discuss-phase [текущая-фаза])
2. Создать план фазы (/gsd:plan-phase [текущая-фаза])
3. Углубить исследование (копать глубже)
4. Просмотреть исследование

```

ПРИМЕЧАНИЕ: DISCOVERY.md НЕ фиксируется отдельно. Он будет зафиксирован при завершении фазы.
</step>

</process>

<success_criteria>
**Уровень 1 (Быстрая проверка):**
- Context7 запрошен для библиотеки/темы
- Текущее состояние подтверждено или проблемы эскалированы
- Устное подтверждение продолжения (без файлов)

**Уровень 2 (Стандартный):**
- Context7 запрошен для всех вариантов
- Находки WebSearch перекрёстно проверены
- DISCOVERY.md создан с рекомендацией
- Уровень уверенности СРЕДНИЙ или выше
- Готов для информирования создания PLAN.md

**Уровень 3 (Глубокое погружение):**
- Область исследования определена
- Context7 исчерпывающе запрошен
- Все находки WebSearch проверены против авторитетных источников
- DISCOVERY.md создан с комплексным анализом
- Отчёт о качестве с атрибуцией источников
- Если находки с НИЗКОЙ уверенностью → контрольные точки валидации определены
- Точка уверенности пройдена
- Готов для информирования создания PLAN.md
</success_criteria>
