<purpose>
Вывести список всех ожидающих задач (todo), разрешить выбор, загрузить полный контекст выбранной задачи и направить к соответствующему действию.
</purpose>

<required_reading>
Прочитайте все файлы, указанные в execution_context вызывающего промпта, перед началом работы.
</required_reading>

<process>

<step name="init_context">
Загрузите контекст задач:

```bash
INIT=$(node ~/.claude/get-shit-done/bin/gsd-tools.js init todos)
```

Извлеките из JSON инициализации: `todo_count`, `todos`, `pending_dir`.

Если `todo_count` равен 0:
```
Нет ожидающих задач.

Задачи фиксируются во время рабочих сессий с помощью /gsd:add-todo.

---

Хотите:

1. Продолжить текущую фазу (/gsd:progress)
2. Добавить задачу сейчас (/gsd:add-todo)
```

Выход.
</step>

<step name="parse_filter">
Проверьте наличие фильтра по области в аргументах:
- `/gsd:check-todos` → показать все
- `/gsd:check-todos api` → фильтр только по area:api
</step>

<step name="list_todos">
Используйте массив `todos` из контекста инициализации (уже отфильтрованный по области, если указано).

Разберите и отобразите нумерованным списком:

```
Ожидающие задачи:

1. Добавить обновление auth-токена (api, 2д назад)
2. Исправить z-index модального окна (ui, 1д назад)
3. Рефакторинг пула соединений БД (database, 5ч назад)

---

Ответьте номером для просмотра деталей, или:
- `/gsd:check-todos [область]` для фильтрации по области
- `q` для выхода
```

Форматируйте возраст как относительное время от метки создания.
</step>

<step name="handle_selection">
Дождитесь ответа пользователя с номером.

Если валидный: загрузить выбранную задачу, продолжить.
Если невалидный: "Неверный выбор. Ответьте номером (1-[N]) или `q` для выхода."
</step>

<step name="load_context">
Прочитайте файл задачи полностью. Отобразите:

```
## [заголовок]

**Область:** [область]
**Создано:** [дата] ([относительное время] назад)
**Файлы:** [список или "Нет"]

### Проблема
[содержимое секции problem]

### Решение
[содержимое секции solution]
```

Если поле `files` содержит записи, прочитайте и кратко опишите каждый.
</step>

<step name="check_roadmap">
Проверьте наличие дорожной карты (можно использовать init progress или прямую проверку файла):

Если `.planning/ROADMAP.md` существует:
1. Проверьте, совпадает ли область задачи с предстоящей фазой
2. Проверьте, пересекаются ли файлы задачи с областью фазы
3. Отметьте совпадение для вариантов действий
</step>

<step name="offer_actions">
**Если задача связана с фазой дорожной карты:**

Используйте AskUserQuestion:
- header: "Действие"
- question: "Эта задача относится к Фазе [N]: [название]. Что хотите сделать?"
- options:
  - "Работать сейчас" — переместить в done, начать работу
  - "Добавить в план фазы" — включить при планировании Фазы [N]
  - "Обсудить подход" — обдумать перед решением
  - "Вернуть назад" — вернуться к списку

**Если нет совпадения с дорожной картой:**

Используйте AskUserQuestion:
- header: "Действие"
- question: "Что хотите сделать с этой задачей?"
- options:
  - "Работать сейчас" — переместить в done, начать работу
  - "Создать фазу" — /gsd:add-phase с этой областью
  - "Обсудить подход" — обдумать перед решением
  - "Вернуть назад" — вернуться к списку
</step>

<step name="execute_action">
**Работать сейчас:**
```bash
mv ".planning/todos/pending/[filename]" ".planning/todos/done/"
```
Обновите STATE.md счётчик задач. Представьте контекст проблемы/решения. Начните работу или спросите как продолжить.

**Добавить в план фазы:**
Отметьте ссылку на задачу в заметках планирования фазы. Оставьте в pending. Вернитесь к списку или завершите.

**Создать фазу:**
Отобразите: `/gsd:add-phase [описание из задачи]`
Оставьте в pending. Пользователь запускает команду в чистом контексте.

**Обсудить подход:**
Оставьте в pending. Начните обсуждение проблемы и подходов.

**Вернуть назад:**
Вернитесь к шагу list_todos.
</step>

<step name="update_state">
После любого действия, изменяющего счётчик задач:

Повторно запустите `init todos` для получения обновлённого счётчика, затем обновите секцию "### Pending Todos" в STATE.md, если она существует.
</step>

<step name="git_commit">
Если задача была перемещена в done/, зафиксируйте изменение:

```bash
git rm --cached .planning/todos/pending/[filename] 2>/dev/null || true
node ~/.claude/get-shit-done/bin/gsd-tools.js commit "docs: начата работа над задачей - [заголовок]" --files .planning/todos/done/[filename] .planning/STATE.md
```

Инструмент автоматически учитывает настройку `commit_docs` и gitignore.

Подтвердите: "Зафиксировано: docs: начата работа над задачей - [заголовок]"
</step>

</process>

<success_criteria>
- [ ] Все ожидающие задачи перечислены с заголовком, областью, возрастом
- [ ] Фильтр по области применён, если указан
- [ ] Полный контекст выбранной задачи загружен
- [ ] Контекст дорожной карты проверен на совпадение с фазой
- [ ] Предложены соответствующие действия
- [ ] Выбранное действие выполнено
- [ ] STATE.md обновлён, если счётчик задач изменился
- [ ] Изменения зафиксированы в git (если задача перемещена в done/)
</success_criteria>
