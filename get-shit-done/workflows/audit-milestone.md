<purpose>
Проверить достижение этапом определения завершённости путём агрегации проверок фаз, контроля межфазовой интеграции и оценки покрытия требований. Читает существующие файлы VERIFICATION.md (фазы уже проверены во время execute-phase), агрегирует технический долг и отложенные пробелы, затем запускает проверщик интеграции для межфазовых связей.
</purpose>

<required_reading>
Прочитайте все файлы, указанные в execution_context вызывающего промпта, перед началом работы.
</required_reading>

<process>

## 0. Инициализация контекста этапа

```bash
INIT=$(node ~/.claude/get-shit-done/bin/gsd-tools.js init milestone-op)
```

Извлеките из JSON инициализации: `milestone_version`, `milestone_name`, `phase_count`, `completed_phases`, `commit_docs`.

Определите модель проверщика интеграции:
```bash
CHECKER_MODEL=$(node ~/.claude/get-shit-done/bin/gsd-tools.js resolve-model gsd-integration-checker --raw)
```

## 1. Определение области этапа

```bash
# Получить фазы в этапе (отсортированные числовым порядком, поддержка десятичных)
node ~/.claude/get-shit-done/bin/gsd-tools.js phases list
```

- Разберите версию из аргументов или определите текущую из ROADMAP.md
- Определите все каталоги фаз в области
- Извлеките определение завершённости этапа из ROADMAP.md
- Извлеките требования, привязанные к этому этапу из REQUIREMENTS.md

## 2. Чтение всех проверок фаз

Для каждого каталога фазы прочитайте VERIFICATION.md:

```bash
cat .planning/phases/01-*/*-VERIFICATION.md
cat .planning/phases/02-*/*-VERIFICATION.md
# и т.д.
```

Из каждого VERIFICATION.md извлеките:
- **Статус:** passed | gaps_found
- **Критические пробелы:** (если есть — это блокеры)
- **Некритические пробелы:** технический долг, отложенные элементы, предупреждения
- **Найденные антипаттерны:** TODO, заглушки, плейсхолдеры
- **Покрытие требований:** какие требования удовлетворены/заблокированы

Если у фазы отсутствует VERIFICATION.md, отметьте как "непроверенная фаза" — это блокер.

## 3. Запуск проверщика интеграции

С собранным контекстом фаз:

```
Task(
  prompt="Проверить межфазовую интеграцию и сквозные потоки.

Фазы: {phase_dirs}
Экспорты фаз: {из SUMMARY}
API маршруты: {созданные маршруты}

Проверить межфазовые связи и сквозные пользовательские потоки.",
  subagent_type="gsd-integration-checker",
  model="{integration_checker_model}"
)
```

## 4. Сбор результатов

Объедините:
- Пробелы и технический долг уровня фаз (из шага 2)
- Отчёт проверщика интеграции (пробелы связей, нарушенные потоки)

## 5. Проверка покрытия требований

Для каждого требования в REQUIREMENTS.md, привязанного к этому этапу:
- Найдите владеющую фазу
- Проверьте статус проверки фазы
- Определите: satisfied | partial | unsatisfied

## 6. Агрегация в v{version}-MILESTONE-AUDIT.md

Создайте `.planning/v{version}-v{version}-MILESTONE-AUDIT.md` со структурой:

```yaml
---
milestone: {version}
audited: {timestamp}
status: passed | gaps_found | tech_debt
scores:
  requirements: N/M
  phases: N/M
  integration: N/M
  flows: N/M
gaps:  # Критические блокеры
  requirements: [...]
  integration: [...]
  flows: [...]
tech_debt:  # Некритические, отложенные
  - phase: 01-auth
    items:
      - "TODO: добавить ограничение частоты запросов"
      - "Предупреждение: нет валидации сложности пароля"
  - phase: 03-dashboard
    items:
      - "Отложено: адаптивная мобильная вёрстка"
---
```

Плюс полный markdown-отчёт с таблицами для требований, фаз, интеграции, техдолга.

**Значения статусов:**
- `passed` — все требования выполнены, нет критических пробелов, минимальный техдолг
- `gaps_found` — существуют критические блокеры
- `tech_debt` — нет блокеров, но накопленные отложенные элементы требуют ревью

## 7. Представление результатов

Маршрутизация по статусу (см. `<offer_next>`).

</process>

<offer_next>
Выводите этот markdown напрямую (не как блок кода). Маршрутизация по статусу:

---

**Если passed:**

## ✓ Этап {version} — Аудит пройден

**Оценка:** {N}/{M} требований удовлетворено
**Отчёт:** .planning/v{version}-MILESTONE-AUDIT.md

Все требования покрыты. Межфазовая интеграция проверена. Сквозные потоки завершены.

───────────────────────────────────────────────────────────────

## ▶ Далее

**Завершить этап** — архивировать и пометить тегом

/gsd:complete-milestone {version}

<sub>/clear сначала → чистое контекстное окно</sub>

───────────────────────────────────────────────────────────────

---

**Если gaps_found:**

## ⚠ Этап {version} — Обнаружены пробелы

**Оценка:** {N}/{M} требований удовлетворено
**Отчёт:** .planning/v{version}-MILESTONE-AUDIT.md

### Неудовлетворённые требования

{Для каждого неудовлетворённого требования:}
- **{REQ-ID}: {описание}** (Фаза {X})
  - {причина}

### Межфазовые проблемы

{Для каждого пробела интеграции:}
- **{откуда} → {куда}:** {проблема}

### Нарушенные потоки

{Для каждого пробела потока:}
- **{название потока}:** прерывается на {шаг}

───────────────────────────────────────────────────────────────

## ▶ Далее

**Планирование закрытия пробелов** — создать фазы для завершения этапа

/gsd:plan-milestone-gaps

<sub>/clear сначала → чистое контекстное окно</sub>

───────────────────────────────────────────────────────────────

**Также доступно:**
- cat .planning/v{version}-MILESTONE-AUDIT.md — посмотреть полный отчёт
- /gsd:complete-milestone {version} — продолжить всё равно (принять техдолг)

───────────────────────────────────────────────────────────────

---

**Если tech_debt (нет блокеров, но накоплен долг):**

## ⚡ Этап {version} — Ревью технического долга

**Оценка:** {N}/{M} требований удовлетворено
**Отчёт:** .planning/v{version}-MILESTONE-AUDIT.md

Все требования выполнены. Нет критических блокеров. Накопленный технический долг требует ревью.

### Технический долг по фазам

{Для каждой фазы с долгом:}
**Фаза {X}: {название}**
- {элемент 1}
- {элемент 2}

### Итого: {N} элементов в {M} фазах

───────────────────────────────────────────────────────────────

## ▶ Варианты

**A. Завершить этап** — принять долг, отслеживать в бэклоге

/gsd:complete-milestone {version}

**B. Запланировать фазу очистки** — устранить долг перед завершением

/gsd:plan-milestone-gaps

<sub>/clear сначала → чистое контекстное окно</sub>

───────────────────────────────────────────────────────────────
</offer_next>

<success_criteria>
- [ ] Область этапа определена
- [ ] Все файлы VERIFICATION.md фаз прочитаны
- [ ] Технический долг и отложенные пробелы агрегированы
- [ ] Проверщик интеграции запущен для межфазовых связей
- [ ] v{version}-MILESTONE-AUDIT.md создан
- [ ] Результаты представлены с действенными следующими шагами
</success_criteria>
