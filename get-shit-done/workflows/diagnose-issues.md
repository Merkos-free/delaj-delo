<purpose>
Оркестрация параллельных агентов отладки для исследования пробелов UAT и поиска корневых причин.

После обнаружения пробелов UAT, запустить по одному агенту отладки на пробел. Каждый агент исследует автономно с предзаполненными симптомами из UAT. Собрать корневые причины, обновить пробелы UAT.md диагнозами, затем передать в plan-phase --gaps с реальными диагнозами.

Оркестратор остаётся лёгким: разобрать пробелы, запустить агентов, собрать результаты, обновить UAT.
</purpose>

<paths>
DEBUG_DIR=.planning/debug

Файлы отладки используют путь `.planning/debug/` (скрытый каталог с точкой в начале).
</paths>

<core_principle>
**Диагностика перед планированием исправлений.**

UAT говорит нам ЧТО сломано (симптомы). Агенты отладки находят ПОЧЕМУ (корневая причина). plan-phase --gaps затем создаёт точечные исправления на основе реальных причин, а не догадок.

Без диагностики: "Комментарий не обновляется" → догадка об исправлении → возможно неверно
С диагностикой: "Комментарий не обновляется" → "useEffect отсутствует зависимость" → точное исправление
</core_principle>

<process>

<step name="parse_gaps">
**Извлечение пробелов из UAT.md:**

Прочитайте секцию "Gaps" (формат YAML):
```yaml
- truth: "Комментарий появляется сразу после отправки"
  status: failed
  reason: "Пользователь сообщил: работает, но не отображается пока не обновлю страницу"
  severity: major
  test: 2
  artifacts: []
  missing: []
```

Для каждого пробела также прочитайте соответствующий тест из секции "Tests" для полного контекста.

Создайте список пробелов:
```
gaps = [
  {truth: "Комментарий появляется сразу...", severity: "major", test_num: 2, reason: "..."},
  {truth: "Кнопка ответа расположена правильно...", severity: "minor", test_num: 5, reason: "..."},
  ...
]
```
</step>

<step name="report_plan">
**Отчёт о плане диагностики пользователю:**

```
## Диагностика {N} пробелов

Запуск параллельных агентов отладки для исследования корневых причин:

| Пробел (Ожидание) | Серьёзность |
|-------------------|-------------|
| Комментарий появляется сразу после отправки | major |
| Кнопка ответа расположена правильно | minor |
| Удаление удаляет комментарий | blocker |

Каждый агент будет:
1. Создавать DEBUG-{slug}.md с предзаполненными симптомами
2. Исследовать автономно (читать код, формировать гипотезы, тестировать)
3. Вернуть корневую причину

Выполняется параллельно — все пробелы исследуются одновременно.
```
</step>

<step name="spawn_agents">
**Запуск агентов отладки параллельно:**

Для каждого пробела заполните шаблон debug-subagent-prompt и запустите:

```
Task(
  prompt=filled_debug_subagent_prompt,
  subagent_type="general-purpose",
  description="Отладка: {truth_short}"
)
```

**Все агенты запускаются в одном сообщении** (параллельное выполнение).

Плейсхолдеры шаблона:
- `{truth}`: Ожидаемое поведение, которое не сработало
- `{expected}`: Из теста UAT
- `{actual}`: Дословное описание пользователя из поля reason
- `{errors}`: Сообщения об ошибках из UAT (или "Не сообщалось")
- `{reproduction}`: "Тест {test_num} в UAT"
- `{timeline}`: "Обнаружено во время UAT"
- `{goal}`: `find_root_cause_only` (поток UAT — plan-phase --gaps обрабатывает исправления)
- `{slug}`: Сгенерирован из truth
</step>

<step name="collect_results">
**Сбор корневых причин от агентов:**

Каждый агент возвращает:
```
## КОРНЕВАЯ ПРИЧИНА НАЙДЕНА

**Сессия отладки:** ${DEBUG_DIR}/{slug}.md

**Корневая причина:** {конкретная причина с доказательствами}

**Сводка доказательств:**
- {ключевая находка 1}
- {ключевая находка 2}
- {ключевая находка 3}

**Затронутые файлы:**
- {файл1}: {что не так}
- {файл2}: {связанная проблема}

**Предложенное направление исправления:** {краткая подсказка для plan-phase --gaps}
```

Разберите каждый возврат для извлечения:
- root_cause: Диагностированная причина
- files: Затронутые файлы
- debug_path: Путь к файлу сессии отладки
- suggested_fix: Подсказка для плана закрытия пробелов

Если агент возвращает `## ИССЛЕДОВАНИЕ БЕЗРЕЗУЛЬТАТНО`:
- root_cause: "Исследование безрезультатно — требуется ручная проверка"
- Отметьте, какая проблема требует ручного внимания
- Включите оставшиеся варианты из ответа агента
</step>

<step name="update_uat">
**Обновление пробелов UAT.md диагнозами:**

Для каждого пробела в секции Gaps добавьте поля artifacts и missing:

```yaml
- truth: "Комментарий появляется сразу после отправки"
  status: failed
  reason: "Пользователь сообщил: работает, но не отображается пока не обновлю страницу"
  severity: major
  test: 2
  root_cause: "useEffect в CommentList.tsx отсутствует зависимость commentCount"
  artifacts:
    - path: "src/components/CommentList.tsx"
      issue: "useEffect отсутствует зависимость"
  missing:
    - "Добавить commentCount в массив зависимостей useEffect"
    - "Вызвать повторный рендер при добавлении нового комментария"
  debug_session: .planning/debug/comment-not-refreshing.md
```

Обновите статус в frontmatter на "diagnosed".

Зафиксируйте обновлённый UAT.md:
```bash
node ~/.claude/get-shit-done/bin/gsd-tools.js commit "docs({phase}): добавлены корневые причины из диагностики" --files ".planning/phases/XX-name/{phase}-UAT.md"
```
</step>

<step name="report_results">
**Отчёт о результатах диагностики и передача:**

Отобразите:
```
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━
 GSD ► ДИАГНОСТИКА ЗАВЕРШЕНА
━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━

| Пробел (Ожидание) | Корневая причина | Файлы |
|-------------------|-----------------|-------|
| Комментарий появляется сразу | отсутствует зависимость useEffect | CommentList.tsx |
| Кнопка ответа расположена правильно | неверный CSS flex order | ReplyButton.tsx |
| Удаление удаляет комментарий | API отсутствует заголовок auth | api/comments.ts |

Сессии отладки: ${DEBUG_DIR}/

Переход к планированию исправлений...
```

Возврат к оркестратору verify-work для автоматического планирования.
НЕ предлагайте ручные следующие шаги — verify-work обрабатывает остальное.
</step>

</process>

<context_efficiency>
Агенты начинают с предзаполненными симптомами из UAT (без сбора симптомов).
Агенты только диагностируют — plan-phase --gaps обрабатывает исправления (без применения исправлений).
</context_efficiency>

<failure_handling>
**Агент не нашёл корневую причину:**
- Пометить пробел как "требуется ручная проверка"
- Продолжить с другими пробелами
- Сообщить о неполной диагностике

**Агент превысил время ожидания:**
- Проверить DEBUG-{slug}.md на частичный прогресс
- Можно возобновить с /gsd:debug

**Все агенты не справились:**
- Что-то системное (права, git и т.д.)
- Сообщить для ручного расследования
- Откат к plan-phase --gaps без корневых причин (менее точно)
</failure_handling>

<success_criteria>
- [ ] Пробелы разобраны из UAT.md
- [ ] Агенты отладки запущены параллельно
- [ ] Корневые причины собраны от всех агентов
- [ ] Пробелы UAT.md обновлены артефактами и недостающими элементами
- [ ] Сессии отладки сохранены в ${DEBUG_DIR}/
- [ ] Передача в verify-work для автоматического планирования
</success_criteria>
