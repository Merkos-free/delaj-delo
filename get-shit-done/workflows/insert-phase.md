<purpose>
Вставить десятичную фазу для срочной работы, обнаруженной в середине этапа, между существующими целочисленными фазами. Использует десятичную нумерацию (72.1, 72.2 и т.д.) для сохранения логической последовательности запланированных фаз при размещении срочных вставок без перенумерации всей дорожной карты.
</purpose>

<required_reading>
Прочитайте все файлы, указанные в execution_context вызывающего промпта, перед началом работы.
</required_reading>

<process>

<step name="parse_arguments">
Разберите аргументы команды:
- Первый аргумент: целочисленный номер фазы, после которой вставить
- Остальные аргументы: описание фазы

Пример: `/gsd:insert-phase 72 Исправить критический баг аутентификации`
-> after = 72
-> description = "Исправить критический баг аутентификации"

Если аргументы отсутствуют:

```
ОШИБКА: Требуются номер фазы и описание
Использование: /gsd:insert-phase <после> <описание>
Пример: /gsd:insert-phase 72 Исправить критический баг аутентификации
```

Выход.

Проверьте, что первый аргумент — целое число.
</step>

<step name="init_context">
Загрузите контекст операции с фазой:

```bash
INIT=$(node ~/.claude/get-shit-done/bin/gsd-tools.js init phase-op "${after_phase}")
```

Проверьте `roadmap_exists` из JSON инициализации. Если false:
```
ОШИБКА: Дорожная карта не найдена (.planning/ROADMAP.md)
```
Выход.
</step>

<step name="insert_phase">
**Делегируйте вставку фазы в gsd-tools:**

```bash
RESULT=$(node ~/.claude/get-shit-done/bin/gsd-tools.js phase insert "${after_phase}" "${description}")
```

CLI выполняет:
- Проверку существования целевой фазы в ROADMAP.md
- Вычисление следующего десятичного номера фазы (с проверкой существующих десятичных на диске)
- Генерацию slug из описания
- Создание каталога фазы (`.planning/phases/{N.M}-{slug}/`)
- Вставку записи фазы в ROADMAP.md после целевой фазы с маркером (INSERTED)

Извлеките из результата: `phase_number`, `after_phase`, `name`, `slug`, `directory`.
</step>

<step name="update_project_state">
Обновите STATE.md для отражения вставленной фазы:

1. Прочитайте `.planning/STATE.md`
2. В секции "## Accumulated Context" → "### Roadmap Evolution" добавьте запись:
   ```
   - Phase {decimal_phase} inserted after Phase {after_phase}: {description} (URGENT)
   ```

Если секция "Roadmap Evolution" не существует, создайте её.
</step>

<step name="completion">
Представьте итоговый отчёт:

```
Фаза {decimal_phase} вставлена после Фазы {after_phase}:
- Описание: {description}
- Каталог: .planning/phases/{decimal-phase}-{slug}/
- Статус: Ещё не запланирована
- Маркер: (INSERTED) — обозначает срочную работу

Дорожная карта обновлена: .planning/ROADMAP.md
Состояние проекта обновлено: .planning/STATE.md

---

## Далее

**Фаза {decimal_phase}: {description}** — срочная вставка

`/gsd:plan-phase {decimal_phase}`

<sub>`/clear` сначала -> чистое контекстное окно</sub>

---

**Также доступно:**
- Проверить влияние вставки: Убедиться, что зависимости Фазы {next_integer} всё ещё актуальны
- Просмотр дорожной карты

---
```
</step>

</process>

<anti_patterns>

- Не используйте это для запланированной работы в конце этапа (используйте /gsd:add-phase)
- Не вставляйте перед Фазой 1 (десятичная 0.1 не имеет смысла)
- Не перенумеровывайте существующие фазы
- Не изменяйте содержимое целевой фазы
- Не создавайте планы сейчас (для этого /gsd:plan-phase)
- Не коммитьте изменения (пользователь решает, когда коммитить)
</anti_patterns>

<success_criteria>
Вставка фазы завершена, когда:

- [ ] `gsd-tools phase insert` выполнена успешно
- [ ] Каталог фазы создан
- [ ] Дорожная карта обновлена записью о новой фазе (включая маркер "(INSERTED)")
- [ ] STATE.md обновлён заметкой об эволюции дорожной карты
- [ ] Пользователь проинформирован о следующих шагах и влиянии на зависимости
</success_criteria>
