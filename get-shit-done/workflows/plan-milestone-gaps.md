<purpose>
Создать все фазы, необходимые для закрытия пробелов, выявленных `/gsd:audit-milestone`. Читает MILESTONE-AUDIT.md, группирует пробелы в логические фазы, создаёт записи фаз в ROADMAP.md и предлагает спланировать каждую фазу. Одна команда создаёт все фазы исправления — без ручного `/gsd:add-phase` для каждого пробела.
</purpose>

<required_reading>
Прочитайте все файлы, указанные в execution_context вызывающего промпта, перед началом работы.
</required_reading>

<process>

## 1. Загрузка результатов аудита

```bash
# Найти самый свежий файл аудита
ls -t .planning/v*-MILESTONE-AUDIT.md 2>/dev/null | head -1
```

Разберите YAML frontmatter для извлечения структурированных пробелов:
- `gaps.requirements` — неудовлетворённые требования
- `gaps.integration` — отсутствующие межфазные связи
- `gaps.flows` — нарушенные сквозные потоки

Если файл аудита отсутствует или пробелов нет, ошибка:
```
Пробелы аудита не найдены. Сначала запустите `/gsd:audit-milestone`.
```

## 2. Приоритизация пробелов

Группировка пробелов по приоритету из REQUIREMENTS.md:

| Приоритет | Действие |
|-----------|----------|
| `must` | Создать фазу, блокирует этап |
| `should` | Создать фазу, рекомендуется |
| `nice` | Спросить пользователя: включить или отложить? |

Для пробелов интеграции/потоков определите приоритет по затронутым требованиям.

## 3. Группировка пробелов в фазы

Кластеризация связанных пробелов в логические фазы:

**Правила группировки:**
- Та же затронутая фаза → объединить в одну фазу исправления
- Та же подсистема (auth, API, UI) → объединить
- Порядок зависимостей (исправить заглушки перед связыванием)
- Фазы должны быть фокусированными: 2-4 задачи каждая

**Пример группировки:**
```
Пробел: DASH-01 не удовлетворён (Дашборд не получает данные)
Пробел: Интеграция Фаза 1→3 (Auth не передаётся в API-вызовы)
Пробел: Поток "Просмотр дашборда" нарушен на этапе получения данных

→ Фаза 6: "Подключение дашборда к API"
  - Добавить fetch в Dashboard.tsx
  - Включить auth-заголовок в fetch
  - Обработать ответ, обновить состояние
  - Отрендерить данные пользователя
```

## 4. Определение номеров фаз

Найти наибольшую существующую фазу:
```bash
# Получить сортированный список фаз, извлечь последнюю
PHASES=$(node ~/.claude/get-shit-done/bin/gsd-tools.js phases list)
HIGHEST=$(echo "$PHASES" | jq -r '.directories[-1]')
```

Новые фазы продолжают нумерацию:
- Если Фаза 5 — наибольшая, пробелы становятся Фазой 6, 7, 8...

## 5. Представление плана закрытия пробелов

```markdown
## План закрытия пробелов

**Этап:** {версия}
**Пробелов к закрытию:** {N} требований, {M} интеграций, {K} потоков

### Предложенные фазы

**Фаза {N}: {Название}**
Закрывает:
- {REQ-ID}: {описание}
- Интеграция: {от} → {к}
Задач: {количество}

**Фаза {N+1}: {Название}**
Закрывает:
- {REQ-ID}: {описание}
- Поток: {название потока}
Задач: {количество}

{Если есть необязательные пробелы:}

### Отложенные (необязательные)

Эти пробелы необязательны. Включить их?
- {описание пробела}
- {описание пробела}

---

Создать эти {X} фаз? (да / скорректировать / отложить все необязательные)
```

Ожидайте подтверждения пользователя.

## 6. Обновление ROADMAP.md

Добавьте новые фазы в текущий этап:

```markdown
### Phase {N}: {Название}
**Goal:** {выведена из закрываемых пробелов}
**Requirements:** {REQ-ID, которые удовлетворяются}
**Gap Closure:** Закрывает пробелы из аудита

### Phase {N+1}: {Название}
...
```

## 7. Создание каталогов фаз

```bash
mkdir -p ".planning/phases/{NN}-{name}"
```

## 8. Коммит обновления дорожной карты

```bash
node ~/.claude/get-shit-done/bin/gsd-tools.js commit "docs(roadmap): add gap closure phases {N}-{M}" --files .planning/ROADMAP.md
```

## 9. Предложение следующих шагов

```markdown
## ✓ Фазы закрытия пробелов созданы

**Добавлены фазы:** {N} - {M}
**Устранённые пробелы:** {количество} требований, {количество} интеграций, {количество} потоков

---

## ▶ Далее

**Спланировать первую фазу закрытия пробелов**

`/gsd:plan-phase {N}`

<sub>`/clear` сначала → чистое контекстное окно</sub>

---

**Также доступно:**
- `/gsd:execute-phase {N}` — если планы уже существуют
- `cat .planning/ROADMAP.md` — просмотреть обновлённую дорожную карту

---

**После завершения всех фаз закрытия пробелов:**

`/gsd:audit-milestone` — повторный аудит для проверки закрытия пробелов
`/gsd:complete-milestone {version}` — архивировать когда аудит пройден
```

</process>

<gap_to_phase_mapping>

## Как пробелы превращаются в задачи

**Пробел требования → Задачи:**
```yaml
gap:
  id: DASH-01
  description: "Пользователь видит свои данные"
  reason: "Дашборд существует, но не получает данные из API"
  missing:
    - "useEffect с fetch на /api/user/data"
    - "Состояние для данных пользователя"
    - "Рендер данных пользователя в JSX"

становится:

phase: "Подключение данных дашборда"
tasks:
  - name: "Добавить получение данных"
    files: [src/components/Dashboard.tsx]
    action: "Добавить useEffect, который получает /api/user/data при монтировании"

  - name: "Добавить управление состоянием"
    files: [src/components/Dashboard.tsx]
    action: "Добавить useState для userData, loading, error состояний"

  - name: "Отрендерить данные пользователя"
    files: [src/components/Dashboard.tsx]
    action: "Заменить заглушку на рендер userData.map"
```

**Пробел интеграции → Задачи:**
```yaml
gap:
  from_phase: 1
  to_phase: 3
  connection: "Auth-токен → API-вызовы"
  reason: "API-вызовы дашборда не включают auth-заголовок"
  missing:
    - "Auth-заголовок в fetch-вызовах"
    - "Обновление токена при 401"

становится:

phase: "Добавление Auth в API-вызовы дашборда"
tasks:
  - name: "Добавить auth-заголовок в fetch"
    files: [src/components/Dashboard.tsx, src/lib/api.ts]
    action: "Включить заголовок Authorization с токеном во все API-вызовы"

  - name: "Обработать ответы 401"
    files: [src/lib/api.ts]
    action: "Добавить перехватчик для обновления токена или перенаправления на логин при 401"
```

**Пробел потока → Задачи:**
```yaml
gap:
  name: "Пользователь просматривает дашборд после логина"
  broken_at: "Загрузка данных дашборда"
  reason: "Нет вызова fetch"
  missing:
    - "Получить данные пользователя при монтировании"
    - "Показать состояние загрузки"
    - "Отрендерить данные пользователя"

становится:

# Обычно та же фаза, что и пробел требования/интеграции
# Пробелы потоков часто пересекаются с другими типами пробелов
```

</gap_to_phase_mapping>

<success_criteria>
- [ ] MILESTONE-AUDIT.md загружен и пробелы разобраны
- [ ] Пробелы приоритизированы (must/should/nice)
- [ ] Пробелы сгруппированы в логические фазы
- [ ] Пользователь подтвердил план фаз
- [ ] ROADMAP.md обновлён новыми фазами
- [ ] Каталоги фаз созданы
- [ ] Изменения закоммичены
- [ ] Пользователь знает о необходимости запустить `/gsd:plan-phase` далее
</success_criteria>