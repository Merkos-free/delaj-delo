<purpose>
Проверить обновления GSD через npm, показать журнал изменений для версий между установленной и последней, получить подтверждение пользователя и выполнить чистую установку с очисткой кэша.
</purpose>

<required_reading>
Прочитайте все файлы, указанные в execution_context вызывающего промпта, перед началом работы.
</required_reading>

<process>

<step name="get_installed_version">
Определите, установлен ли GSD локально или глобально, проверив оба расположения:

```bash
# Сначала проверить локально (приоритет)
if [ -f "./.claude/get-shit-done/VERSION" ]; then
  cat "./.claude/get-shit-done/VERSION"
  echo "LOCAL"
elif [ -f ~/.claude/get-shit-done/VERSION ]; then
  cat ~/.claude/get-shit-done/VERSION
  echo "GLOBAL"
else
  echo "UNKNOWN"
fi
```

Разберите вывод:
- Если последняя строка "LOCAL": установленная версия — первая строка, использовать флаг `--local` для обновления
- Если последняя строка "GLOBAL": установленная версия — первая строка, использовать флаг `--global` для обновления
- Если "UNKNOWN": перейти к шагу установки (считать версию 0.0.0)

**Если файл VERSION отсутствует:**
```
## Обновление GSD

**Установленная версия:** Неизвестна

Ваша установка не включает отслеживание версий.

Запуск свежей установки...
```

Перейти к шагу установки (считать версию 0.0.0 для сравнения).
</step>

<step name="check_latest_version">
Проверьте npm на наличие последней версии:

```bash
npm view get-shit-done-cc version 2>/dev/null
```

**Если проверка npm не удалась:**
```
Не удалось проверить обновления (нет сети или npm недоступен).

Для обновления вручную: `npx get-shit-done-cc --global`
```

Выход.
</step>

<step name="compare_versions">
Сравните установленную и последнюю версии:

**Если установленная == последняя:**
```
## Обновление GSD

**Установлена:** X.Y.Z
**Последняя:** X.Y.Z

У вас уже установлена последняя версия.
```

Выход.

**Если установленная > последняя:**
```
## Обновление GSD

**Установлена:** X.Y.Z
**Последняя:** A.B.C

Вы опережаете последний релиз (версия для разработки?).
```

Выход.
</step>

<step name="show_changes_and_confirm">
**Если доступно обновление**, получите и покажите что нового ПЕРЕД обновлением:

1. Загрузите changelog с GitHub raw URL
2. Извлеките записи между установленной и последней версиями
3. Покажите предпросмотр и запросите подтверждение:

```
## Доступно обновление GSD

**Установлена:** 1.5.10
**Последняя:** 1.5.15

### Что нового
────────────────────────────────────────────────────────────

## [1.5.15] - 2026-01-20

### Добавлено
- Функция X

## [1.5.14] - 2026-01-18

### Исправлено
- Исправление бага Y

────────────────────────────────────────────────────────────

⚠️  **Примечание:** Установщик выполняет чистую установку папок GSD:
- `commands/gsd/` будет очищена и заменена
- `get-shit-done/` будет очищена и заменена
- Файлы `agents/gsd-*` будут заменены

(Пути относительно вашего расположения установки: `~/.claude/` для глобальной, `./.claude/` для локальной)

Ваши пользовательские файлы в других расположениях сохранены:
- Пользовательские команды не в `commands/gsd/` ✓
- Пользовательские агенты без префикса `gsd-` ✓
- Пользовательские хуки ✓
- Ваши файлы CLAUDE.md ✓

Если вы изменяли файлы GSD напрямую, они будут автоматически скопированы в `gsd-local-patches/` и могут быть повторно применены командой `/gsd:reapply-patches` после обновления.
```

Используйте AskUserQuestion:
- Question: "Продолжить обновление?"
- Options:
  - "Да, обновить сейчас"
  - "Нет, отменить"

**Если пользователь отменяет:** Выход.
</step>

<step name="run_update">
Запустите обновление, используя тип установки, определённый на шаге 1:

**Если ЛОКАЛЬНАЯ установка:**
```bash
npx get-shit-done-cc --local
```

**Если ГЛОБАЛЬНАЯ установка (или неизвестно):**
```bash
npx get-shit-done-cc --global
```

Захватите вывод. Если установка не удалась, покажите ошибку и выйдите.

Очистите кэш обновления, чтобы индикатор в строке статуса исчез:

**Если ЛОКАЛЬНАЯ установка:**
```bash
rm -f ./.claude/cache/gsd-update-check.json
```

**Если ГЛОБАЛЬНАЯ установка:**
```bash
rm -f ~/.claude/cache/gsd-update-check.json
```
</step>

<step name="display_result">
Сформатируйте сообщение о завершении (changelog уже был показан на шаге подтверждения):

```
╔═══════════════════════════════════════════════════════════╗
║  GSD Обновлён: v1.5.10 → v1.5.15                          ║
╚═══════════════════════════════════════════════════════════╝

⚠️  Перезапустите Claude Code, чтобы подхватить новые команды.

[Полный changelog](https://github.com/glittercowboy/get-shit-done/blob/main/CHANGELOG.md)
```
</step>


<step name="check_local_patches">
После завершения обновления проверьте, обнаружил ли установщик и сохранил ли локально изменённые файлы:

Проверьте наличие gsd-local-patches/backup-meta.json в каталоге конфигурации.

**Если патчи найдены:**

```
Локальные патчи были сохранены перед обновлением.
Запустите /gsd:reapply-patches для объединения ваших изменений с новой версией.
```

**Если патчей нет:** Продолжить нормально.
</step>
</process>

<success_criteria>
- [ ] Установленная версия прочитана корректно
- [ ] Последняя версия проверена через npm
- [ ] Обновление пропущено, если уже актуальная версия
- [ ] Changelog загружен и показан ПЕРЕД обновлением
- [ ] Предупреждение о чистой установке показано
- [ ] Подтверждение пользователя получено
- [ ] Обновление выполнено успешно
- [ ] Напоминание о перезапуске показано
</success_criteria>
